rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function profileExists() {
      return isSignedIn() && exists(/databases/$(database)/documents/profiles/$(request.auth.uid));
    }
    
    function getProfile() {
      return profileExists()
        ? get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data
        : null;
    }
    
    function isAdmin() {
      return profileExists() && getProfile() != null && getProfile().role == 'admin';
    }
    
    function isManager() {
      return profileExists() && getProfile() != null && getProfile().role == 'manager';
    }

    function isManagerOrAdmin() {
      return isAdmin() || isManager();
    }
    
    function userCompanyId() {
      return (profileExists() && getProfile().company_id != null)
        ? getProfile().company_id
        : '__NO_COMPANY__';
    }
    
    function companyExists(companyId) {
      return companyId != null && exists(/databases/$(database)/documents/companies/$(companyId));
    }
    
    // Logic: Check if the COMPANY is active, not the individual user
    function isCompanyActive() {
      return profileExists() &&
        companyExists(userCompanyId()) &&
        (
          get(/databases/$(database)/documents/companies/$(userCompanyId())).data.subscription_status == 'active' ||
          get(/databases/$(database)/documents/companies/$(userCompanyId())).data.subscription_status == 'trial'
        );
    }
    
    // ============================================
    // PROFILES
    // ============================================
    match /profiles/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      // Any authenticated user can read profiles in their company
      allow read: if isSignedIn() && (
        request.auth.uid == userId || 
        isAdmin() || 
        resource.data.company_id == userCompanyId()
      );
      
      // Allow users to create their own profile during signup
      // OR allow admins to create any profile
      allow create: if isSignedIn() && (
        (request.auth.uid == userId) ||
        isAdmin()
      );
      
      // Users can update their own non-sensitive fields
      // Admins can update any profile
      // Managers can update profiles in their company
      allow update: if isSignedIn() && (
        isAdmin() ||
        (
          request.auth.uid == userId &&
          // Allow changing company_id ONLY if user doesn't have one yet
          (
            request.resource.data.company_id == resource.data.company_id ||
            resource.data.company_id == null ||
            !('company_id' in resource.data)
          ) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['expoPushToken', 'pushTokenUpdatedAt', 'display_name', 'photo_url', 'phone', 'updated_at', 'company_id', 'role'])
        ) ||
        (
          isManager() && userCompanyId() == resource.data.company_id &&
          request.resource.data.company_id == resource.data.company_id
        )
      );
      
      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // ============================================
    // ACCESS CODES
    // ============================================
    match /access_codes/{codeId} {
      // Anyone can read access codes (needed for verification during signup before auth)
      allow read: if true;
      
      // Only managers and admins can create access codes for their company
      allow create: if isSignedIn() && (
        (isManager() && request.resource.data.company_id == userCompanyId()) ||
        isAdmin()
      );
      
      // Managers/admins can update codes in their company
      // Any authenticated user can mark an unused code as used during signup
      allow update: if isSignedIn() && (
        (
          (isManager() || isAdmin()) &&
          resource.data.company_id == userCompanyId()
        ) ||
        (
          // User marking code as used during signup (no profile exists yet)
          request.resource.data.used == true &&
          !resource.data.used &&
          request.resource.data.used_by == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['used', 'used_at', 'used_by', 'usedAt', 'usedBy', 'updated_at'])
        )
      );
      
      allow delete: if isSignedIn() && (isManager() || isAdmin()) && resource.data.company_id == userCompanyId();
    }

    // ============================================
    // COMPANIES
    // ============================================
    match /companies/{companyId} {
      // Users in the company can read their company
      // Admins can read any company
      // Users can read companies they created (needed for trial check during signup before profile exists)
      allow read: if isSignedIn() && (
        userCompanyId() == companyId || 
        isAdmin() ||
        resource.data.created_by == request.auth.uid
      );
      
      // Allow authenticated users to create companies (during signup)
      allow create: if isSignedIn();
      
      // Only managers and admins can update companies
      allow update: if isSignedIn() && (isAdmin() || (isManager() && userCompanyId() == companyId));
      
      // Companies should not be deleted (archive instead)
      allow delete: if false;
    }

    // ============================================
    // TOOLS
    // ============================================
    match /tools/{toolId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && userCompanyId() == request.resource.data.company_id && isCompanyActive();
      allow update: if isSignedIn() &&
        userCompanyId() == request.resource.data.company_id &&
        request.resource.data.company_id == resource.data.company_id &&
        isCompanyActive();
      allow delete: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
    }

    // ============================================
    // LOCATIONS
    // ============================================
    match /locations/{locationId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && (
        (isManager() && userCompanyId() == request.resource.data.company_id && isCompanyActive()) ||
        isAdmin()
      );
      allow update: if isSignedIn() && (
        (
          isManager() &&
          userCompanyId() == resource.data.company_id &&
          request.resource.data.company_id == resource.data.company_id &&
          isCompanyActive()
        ) ||
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        (isManager() && userCompanyId() == resource.data.company_id && isCompanyActive()) ||
        isAdmin()
      );
    }

    // ============================================
    // TOOL HISTORY
    // ============================================
    match /tool_history/{historyId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && userCompanyId() == request.resource.data.company_id && isCompanyActive();
      // History is immutable - only admins can modify/delete
      allow update, delete: if isAdmin();
    }

    // ============================================
    // VEHICLES
    // ============================================
    match /vehicles/{vehicleId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && userCompanyId() == request.resource.data.company_id && isCompanyActive();
      allow update: if isSignedIn() &&
        userCompanyId() == resource.data.company_id &&
        request.resource.data.company_id == resource.data.company_id &&
        isCompanyActive();
      allow delete: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
    }

    // ============================================
    // VEHICLE INSPECTIONS
    // ============================================
    match /vehicle_inspections/{inspectionId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && userCompanyId() == request.resource.data.company_id && isCompanyActive();
      // Users can update their own inspections, managers can update any in their company
      allow update: if isSignedIn() && (
        (
          resource.data.inspected_by == request.auth.uid &&
          userCompanyId() == resource.data.company_id &&
          isCompanyActive()
        ) ||
        (
          isManager() &&
          userCompanyId() == resource.data.company_id &&
          isCompanyActive()
        ) ||
        isAdmin()
      ) && request.resource.data.company_id == resource.data.company_id;
      allow delete: if isSignedIn() && (
        (isManager() && userCompanyId() == resource.data.company_id && isCompanyActive()) ||
        isAdmin()
      );
    }

    // ============================================
    // VEHICLE DEFECTS
    // ============================================
    match /vehicle_defects/{defectId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && userCompanyId() == request.resource.data.company_id && isCompanyActive();
      allow update: if isSignedIn() && (
        (
          isManager() &&
          userCompanyId() == resource.data.company_id &&
          request.resource.data.company_id == resource.data.company_id &&
          isCompanyActive()
        ) ||
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        (isManager() && userCompanyId() == resource.data.company_id && isCompanyActive()) ||
        isAdmin()
      );
    }

    // ============================================
    // VEHICLE DAMAGE REPORTS
    // ============================================
    match /vehicle_damage_reports/{reportId} {
      allow read: if isSignedIn() && userCompanyId() == resource.data.company_id && isCompanyActive();
      allow create: if isSignedIn() && userCompanyId() == request.resource.data.company_id && isCompanyActive();
      allow update: if isSignedIn() && (
        (
          isManager() &&
          userCompanyId() == resource.data.company_id &&
          request.resource.data.company_id == resource.data.company_id &&
          isCompanyActive()
        ) ||
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        (isManager() && userCompanyId() == resource.data.company_id && isCompanyActive()) ||
        isAdmin()
      );
    }

    // ============================================
    // PROMO CODES
    // ============================================
    match /promoCodes/{codeId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && (
        isAdmin() ||
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['used', 'usedAt', 'usedBy', 'usedCount', 'lastUsedAt', 'lastUsedBy']) &&
          (
            !request.resource.data.hasAny(['usedBy', 'lastUsedBy']) ||
            request.resource.data.usedBy == request.auth.uid ||
            request.resource.data.lastUsedBy == request.auth.uid
          ) &&
          !(resource.data.used == true && request.resource.data.used == false) &&
          (
            request.resource.data.usedCount == null ||
            resource.data.usedCount == null ||
            request.resource.data.usedCount >= resource.data.usedCount
          ) &&
          (
            resource.data.expiresAt == null ||
            resource.data.expiresAt > request.time
          ) &&
          (
            resource.data.maxUses == null ||
            request.resource.data.usedCount == null ||
            request.resource.data.usedCount <= resource.data.maxUses
          ) &&
          (
            request.resource.data.used != true ||
            request.resource.data.usedBy == request.auth.uid
          )
        )
      );
      allow delete: if isSignedIn() && isAdmin();
    }

    // ============================================
    // PROMOTIONAL SUBSCRIPTIONS
    // ============================================
    match /promotionalSubscriptions/{subId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.companyId != null && resource.data.companyId == userCompanyId()) ||
        isAdmin()
      );
      // Simplified create rule - detailed validation handled in app code within transaction
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        (
          request.resource.data.companyId == null ||
          request.resource.data.companyId == userCompanyId()
        ) &&
        request.resource.data.promoCode != null &&
        exists(/databases/$(database)/documents/promoCodes/$(request.resource.data.promoCode));
      allow update, delete: if isSignedIn() && isAdmin();
    }

    // ============================================
    // INVITES
    // ============================================
    match /invites/{inviteId} {
      allow read: if isSignedIn() && (
        isAdmin() ||
        resource.data.companyId == userCompanyId() ||
        resource.data.email == request.auth.token.email
      );
      allow create: if isSignedIn() && isManagerOrAdmin() &&
        request.resource.data.companyId == userCompanyId();
      allow update: if isSignedIn() && (
        isAdmin() ||
        (isManager() && resource.data.companyId == userCompanyId())
      );
      allow delete: if isSignedIn() && (
        isAdmin() ||
        (isManager() && resource.data.companyId == userCompanyId())
      );
    }

    // ============================================
    // APP CONFIG (for version checking)
    // ============================================
    match /app_config/{configId} {
      // Anyone can read app config (needed for update checks before login)
      allow read: if true;
      // Only admins can write app config
      allow write: if isAdmin();
    }

    // ============================================
    // NOTIFICATION LOGS (for debugging/audit)
    // ============================================
    match /notification_logs/{logId} {
      allow read: if isAdmin();
      // Only Cloud Functions can write (they bypass security rules)
      allow write: if false;
    }

    // ============================================
    // GLOBAL ADMIN OVERRIDE
    // ============================================
    match /{path=**} {
      allow read, write: if isAdmin();
    }
  }
}
